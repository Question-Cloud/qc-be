# QuestionCloud - 수능 문제 거래 플랫폼

QuestionCloud는 수학, 물리, 지구과학, 화학, 생명과학 문제를 거래할 수 있는 플랫폼입니다.   
누구나 크리에이터가 될 수 있으며 본인이 만든 문제를 올려 판매할 수 있습니다.   
사용자는 포인트를 이용해 원하는 문제를 구매할 수 있으며, 포인트는 현금 결제를 통해 충전하는 방식으로 운영됩니다.   
이커머스의 비즈니스 모델을 구축하는 것을 목표로 하고 있으며 정교한 결제 시스템을 구축하는 것에 중점을 두었습니다.

# 프로젝트 아키텍처

<img width="667" alt="image" src="https://github.com/user-attachments/assets/122699cb-8c58-45c7-9db7-abd93542b933" />

# 프로젝트 Stack

Spring Boot, Maria DB, JPA, Querydsl, Redis, AWS SNS, AWS SQS, Mongo DB, Docker, AWS EC2, AWS RDS, AWS Elasticache

# 멀티 모듈

`qc-application` : 유저가 사용하는 API를 제공하는 Spring Boot Application입니다.

`qc-config` : Github Submodule을 이용하여 서버 설정에 필요한 환경변수를 관리합니다.

`qc-core` : 도메인 클래스, 도메인 로직, 엔티티 클래스, 레포지토리가 포함되어 있는 공통 모듈입니다.

`qc-external-pg-api`: 외부 PG 솔루션(Portone) API를 이용하여 결제를 처리하는 모듈입니다.

`qc-lock-manager` : Redis + Redisson을 이용하여 분산락을 처리하는 모듈입니다.

`qc-social-api` : KAKAO, NAVER, GOOGLE OAUTH API를 통해 소셜 서비스의 인증을 처리하는 모듈입니다

# 구현 API

**인증**

- 이메일 로그인
- 소셜 로그인 (KAKAO, NAVER, GOOGLE)
- 토큰 Refresh

**장바구니**

- 장바구니 조회
- 장바구니 상품 추가
- 장바구니 상품 삭제

**크리에이터**

- 크리에이터 정보 조회

**FEED**

- 내가 구매한 문제 목록 조회
- 내가 구독중인 크리에이터 조회

**문제 HUB**

- 문제 목록 조회 (필터링, 페이징)
- 문제 카테고리 조회
- 문제 상세 조회
- 문제 리뷰 조회 (페이징)
- 내가 작성한 문제 리뷰 조회
- 문제 리뷰 등록 / 수정 / 삭제

**포인트 충전**

- 포인트 충전 주문 생성
- 포인트 충전 (PG Webhook 용)
- 포인트 충전 결제 완료 여부 조회
- 포인트 충전 내역 조회

**문제 구매**

- 문제 구매
- 문제 구매 내역 조회

**문제 게시판**

- (문제 게시글/댓글) 등록 / 수정 / 삭제
- (문제 게시글/댓글) 조회 (페이징)

**구독**

- 크리에이터 구독/구독 취소
- 특정 크리에이터 구독 여부 조회

**사용자**

- 회원가입
- 계정 찾기 / 비밀번호 초기화
- 내 프로필 조회 / 수정
- 보유 포인트 조회

**쿠폰**

- 쿠폰 등록
- 사용 가능한 쿠폰 조회

**크리에이터 WorkSpace**

- 크리에이터 등록 신청
- 크리에이터 프로필 조회 / 수정
- 자작 문제 등록 / 수정 / 삭제

# Deep DIVE

## Mongo DB 조회 성능 최적화

기존의 문제 결제 내역 조회 SQL은 테이블 8개를 JOIN하는 방식이였습니다.   
이는 코드의 복잡도가 올라갔고 성능 상 이슈가 발생할 것이라고 예상하여 Mongo DB로 전환하였습니다.   
하지만 성능테스트 결과 Mongo DB 방식이 더 낮은 성능을 보여주었습니다.   
여러 레퍼런스를 찾아보고 Intellij 프로파일링 기능 및 Mongo DB Query Explain을 통해 병목 지점을 추적하여 개선하였습니다.

- 프로파일링 및 Query Explain을 통한 병목 지점 추적
- 복합 인덱스를 활용해 불필요한 Sort 단계 제거 및 성능 개선
- Spring Data Mongo의 기본 매핑 Converter에서 병목 현상을 확인 후 Custom Converter로 개선.
- TPS 1937 -> 3900
- [관련 포스팅](https://e4g3r.tistory.com/8)

## Transactional Outbox Pattern을 이용한 메시지 발행 보장

네트워크 문제 혹은 SNS 장애로 인한 Topic 발행을 실패하는 경우를 고려하지 않아 데이터의 정합성이 어긋날 수 있다는 것을 인지하였습니다.   
예를 들어 결제는 처리되었지만 Topic 발행에 실패하는 경우 이벤트 처리가 진행되지 않아 사용자 입장에서는 포인트만 차감되는 문제가 발생할 수 있습니다.   
이를 방지하기 위해 이벤트 발행 로그를 보관하는 별도의 테이블을 생성하고 주기적으로 로그를 확인하여 발행되지 못한 이벤트를 재발행할 수 있는 구조로 설계하였습니다.   
비즈니스 로직과 이벤트 발행 로그 저장 로직을 하나의 트랜젝션으로 처리하여 이벤트 발행 로그가 저장됨을 보장받도록 하였습니다.

- [관련 포스팅](https://e4g3r.tistory.com/13)

## 메시지 발행을 통한 결제 취소 처리 보장

포인트 충전 결제 도중 예외가 발생하면 결제 취소 처리 및 롤백 처리를 위한 메서드가 호출됩니다.   
하지만 예외발생 원인이 DB 장애, 외부 API 장애일 경우 바로 롤백 처리를 진행하면 장애가 복구 되지 않았을 확률이 높기 때문에   
예외 처리 중에 또 예외가 발생할 수 있습니다. 따라서 결제 취소 처리 로직이 완전히 처리 되지 않고 유실될 수 있게 됩니다.   
예외 처리 도중 예외가 발생하는 경우를 고려하여 메시지를 발행하여 일정시간 이후 다시 예외처리를 수행하도록 처리하였습니다.

- [관련포스팅](https://e4g3r.tistory.com/12)

## Mongo DB를 활용한 조회용 모델 설계

결제 내역 조회 시 8개 테이블 조인을 포함한 복잡한 Querydsl 코드를 사용하였고 이를 개선하기 위해 Mongo DB를 도입하였습니다.

- 결제 내역 데이터를 문서형 모델로 전환하여 Mongo DB에 저장.
- 조회 시 단순한 쿼리만으로 데이터를 조회할 수 있게 됨.
- [관련 포스팅](https://e4g3r.tistory.com/7)

## 리뷰 평점 통계 성능 개선

각 문제마다 리뷰의 평균 평점을 구해야하는 요구사항이 있었습니다.   
이를 위해 API 요청 시 마다 DB의 SUM, COUNT 함수를 사용하여 리뷰 평점 통계를 계산하였으나,   
데이터 증가에 따른 성능 저하 발생함을 확인하였고 개선하기 위해 별도의 리뷰 평점 통계 데이터를    
보관하는 테이블을 설계하여 해결하였습니다.

- 리뷰 평점 통계 데이터를 별도 테이블에 저장
- 리뷰 생성, 수정, 삭제 시 마다 간단한 로직으로 통계 데이터를 계산 후 업데이트
- 리뷰 평점 조회 API는 리뷰 데이터 증가에 영향을 받지 않게 됨.
- [관련 포스팅](https://e4g3r.tistory.com/3)

## 결제 프로세스 설계 및 개선

결제 안정성을 보장하기 위해 결제 관련 메서드를 하나로 묶어 단일 트랜젝션으로 처리하였습니다.   
해당 방식은 예외가 발생하면 무조건 결제를 취소하고 롤백처리를 하기 때문에 사용자입장에서는 안전한 결제가 보장될 수 있습니다.   
그러나 **외부 API 사용**이 트랜젝션에 포함되고 있었고 **결제 단계 별**로 조치해야 할 상황이 다르단 것을 분석후 개선하였습니다.

- 외부 API 요청과 트랜잭션 분리.
- 결제 프로세스를 단계별로 나누고, 예외 처리 로직을 강화하여 효율성과 안정성을 동시에 확보.
- [관련 포스팅](https://e4g3r.tistory.com/5)

## 멀티 모듈 및 프로젝트 구조 설계

- 공통 모듈 도입: 유저 및 백오피스 서버에서 공통적으로 사용하는 도메인 클래스, 엔티티, 레포지토리를 모듈화하여 중복을 제거하고 유지보수성을 향상.
- 3-레이어드 아키텍처 개선: 서비스 레이어를 비즈니스 로직 중심으로 설계하고, 구현 로직이 복잡할 경우 Implement 레이어에 분리하여 가독성과 확장성을 강화
- [관련 포스팅](https://velog.io/@dlwlrma/%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%EA%B5%AC%EC%A1%B0%EC%B5%9C%EC%A2%85%EC%A7%84%EC%A7%9C%EC%B5%9C%EC%A2%85%EC%9D%B4%EB%B2%88%EC%97%90%EC%B5%9C%EC%A2%85.spring)
